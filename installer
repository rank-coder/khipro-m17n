#!/bin/bash

# KhiproKeyboard Installer Script
# This script installs KhiproKeyboard for IBus and Fcitx5

set -e  # Exit on any error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Function to detect distribution
detect_distro() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        echo "$ID"
    elif command -v lsb_release &> /dev/null; then
        lsb_release -is | tr '[:upper:]' '[:lower:]'
    else
        echo "unknown"
    fi
}

# Function to check if command exists
command_exists() {
    command -v "$1" &> /dev/null
}

# Function to check if package is installed (for Debian/Ubuntu)
check_package_debian() {
    dpkg -l "$1" 2>/dev/null | grep -q '^ii'
}

# Function to check if package is installed (for Fedora/RHEL)
check_package_fedora() {
    rpm -q "$1" &> /dev/null
}

# Function to check if package is installed (for Arch)
check_package_arch() {
    pacman -Q "$1" &> /dev/null
}

# Welcome message
echo "=========================================="
echo "    KhiproKeyboard Installer"
echo "=========================================="
echo ""

# Check if running as root for the installation part
if [ "$EUID" -ne 0 ]; then
    print_error "This script requires sudo privileges for installation."
    print_status "Please run with: sudo bash installer"
    exit 1
fi

# Check if Git is installed
print_status "Checking for Git..."
if ! command_exists git; then
    print_error "Git is not installed but required to download KhiproKeyboard."
    distro=$(detect_distro)
    case $distro in
        ubuntu|debian)
            print_status "To install Git on Ubuntu/Debian:"
            echo "  sudo apt update && sudo apt install git"
            ;;
        fedora|rhel|centos)
            print_status "To install Git on Fedora/RHEL/CentOS:"
            echo "  sudo dnf install git"
            ;;
        arch|manjaro)
            print_status "To install Git on Arch/Manjaro:"
            echo "  sudo pacman -S git"
            ;;
        *)
            print_status "Please install Git using your distribution's package manager."
            ;;
    esac
    exit 1
else
    print_success "Git is installed"
fi

# Check for input method frameworks and their m17n support
print_status "Checking input method frameworks and m17n support..."

ibus_installed=false
fcitx_installed=false
missing_packages=()

# Check IBus
if command_exists ibus; then
    ibus_installed=true
    print_status "IBus is installed"
    
    # Check for ibus-m17n
    if ! check_package_debian "ibus-m17n" 2>/dev/null && \
       ! check_package_fedora "ibus-m17n" 2>/dev/null && \
       ! check_package_arch "ibus-m17n" 2>/dev/null; then
        missing_packages+=("ibus-m17n")
        print_warning "ibus-m17n is not installed (required for IBus users)"
    else
        print_success "ibus-m17n is installed"
    fi
fi

# Check Fcitx5
if command_exists fcitx5; then
    fcitx_installed=true
    print_status "Fcitx5 is installed"
    
    # Check for fcitx5-m17n
    if ! check_package_debian "fcitx5-m17n" 2>/dev/null && \
       ! check_package_fedora "fcitx5-m17n" 2>/dev/null && \
       ! check_package_arch "fcitx5-m17n" 2>/dev/null; then
        missing_packages+=("fcitx5-m17n")
        print_warning "fcitx5-m17n is not installed (required for Fcitx5 users)"
    else
        print_success "fcitx5-m17n is installed"
    fi
fi

# Check if any input method is installed
if [ "$ibus_installed" = false ] && [ "$fcitx_installed" = false ]; then
    print_error "No input method framework found!"
    print_status "You need to install either IBus or Fcitx5 to use KhiproKeyboard."
    distro=$(detect_distro)
    case $distro in
        ubuntu|debian)
            print_status "To install IBus: sudo apt install ibus ibus-m17n"
            print_status "To install Fcitx5: sudo apt install fcitx5 fcitx5-m17n"
            ;;
        fedora|rhel|centos)
            print_status "To install IBus: sudo dnf install ibus ibus-m17n"
            print_status "To install Fcitx5: sudo dnf install fcitx5 fcitx5-m17n"
            ;;
        arch|manjaro)
            print_status "To install IBus: sudo pacman -S ibus ibus-m17n"
            print_status "To install Fcitx5: sudo pacman -S fcitx5 fcitx5-m17n"
            ;;
        *)
            print_status "Please install IBus or Fcitx5 with m17n support using your distribution's package manager."
            ;;
    esac
    exit 1
fi

# Warn about missing m17n packages
if [ ${#missing_packages[@]} -gt 0 ]; then
    echo ""
    print_warning "Some required m17n packages are missing:"
    for pkg in "${missing_packages[@]}"; do
        echo "  - $pkg"
    done
    
    distro=$(detect_distro)
    case $distro in
        ubuntu|debian)
            print_status "To install missing packages on Ubuntu/Debian:"
            echo "  sudo apt update && sudo apt install ${missing_packages[*]}"
            ;;
        fedora|rhel|centos)
            print_status "To install missing packages on Fedora/RHEL/CentOS:"
            echo "  sudo dnf install ${missing_packages[*]}"
            ;;
        arch|manjaro)
            print_status "To install missing packages on Arch/Manjaro:"
            echo "  sudo pacman -S ${missing_packages[*]}"
            ;;
        *)
            print_status "Please install the missing packages using your distribution's package manager:"
            echo "  ${missing_packages[*]}"
            ;;
    esac
    
    echo ""
    read -p "Do you want to continue with installation anyway? (y/N): " continue_choice
    continue_choice=${continue_choice:-N}
    if [[ ! $continue_choice =~ ^[Yy]$ ]]; then
        print_status "Installation cancelled. Please install the required packages first."
        exit 1
    fi
    print_warning "Continuing installation without required m17n packages..."
    print_warning "KhiproKeyboard may not work until you install the missing packages."
    echo ""
fi

# Branch selection
print_status "Checking installation branch..."
read -p "Install stable release from the main branch? (Y/n): " branch_choice
branch_choice=${branch_choice:-Y}

if [[ $branch_choice =~ ^[Nn]$ ]]; then
    print_status "Fetching available branches from GitHub..."
    
    # Get list of branches from remote repository
    branches=$(git ls-remote --heads https://github.com/rank-coder/khipro-m17n.git 2>/dev/null | \
               awk '{print $2}' | \
               sed 's#refs/heads/##' | \
               sort)
    
    if [ -z "$branches" ]; then
        print_warning "Could not fetch branch list. Please check your internet connection."
        print_status "You can view branches at: https://github.com/rank-coder/khipro-m17n/branches"
    else
        echo ""
        print_success "Available branches:"
        
        # Store branches in an array for number selection
        branches_array=()
        counter=1
        while IFS= read -r branch; do
            echo " $counter. $branch"
            branches_array+=("$branch")
            ((counter++))
        done <<< "$branches"
        echo ""
    fi
    
    read -p "Enter the branch name or number: " branch_input
    if [ -z "$branch_input" ]; then
        print_warning "No branch specified. Using 'main' branch."
        branch_name="main"
    else
        # Check if input is a number
        if [[ "$branch_input" =~ ^[0-9]+$ ]]; then
            # User entered a number
            index=$((branch_input - 1))
            if [ $index -ge 0 ] && [ $index -lt ${#branches_array[@]} ]; then
                branch_name="${branches_array[$index]}"
                print_success "Selected branch: $branch_name"
            else
                print_error "Invalid number. Please select a number between 1 and ${#branches_array[@]}."
                exit 1
            fi
        else
            # User entered a branch name
            branch_name="$branch_input"
            # Verify the branch exists if we have the list
            if [ -n "$branches" ]; then
                if echo "$branches" | grep -q "^${branch_name}$"; then
                    print_success "Branch '$branch_name' found!"
                else
                    print_warning "Branch '$branch_name' not found in the list, but will attempt to use it anyway."
                fi
            fi
        fi
        print_status "Will install from branch: $branch_name"
    fi
else
    branch_name="main"
    print_status "Using stable release (main branch)"
fi

# Installation process begins
print_status "Starting KhiproKeyboard installation..."

# Remove existing files
print_status "Cleaning up previous installations..."
rm -f /usr/share/m17n/bn-khipro*.mim 2>/dev/null || true
rm -rf /tmp/khipro-m17n 2>/dev/null || true

# Clone repository
print_status "Downloading KhiproKeyboard from GitHub..."
if [ "$branch_name" = "main" ]; then
    git clone https://github.com/rank-coder/khipro-m17n.git /tmp/khipro-m17n
else
    git clone --branch "$branch_name" https://github.com/rank-coder/khipro-m17n.git /tmp/khipro-m17n
fi

# Check if clone was successful
if [ ! -d /tmp/khipro-m17n ]; then
    print_error "Failed to clone repository. Please check your internet connection and branch name."
    exit 1
fi

print_success "Repository cloned successfully!"

# Copy files
print_status "Installing keyboard files..."
cd /tmp/khipro-m17n

# Check if the required files exist
if [ ! -f bn-khipro.mim ]; then
    print_error "Required file bn-khipro.mim not found in the repository!"
    exit 1
fi

cp bn-khipro*.mim /usr/share/m17n/

# Copy icon if it exists
if [ -f bn-khipro.png ]; then
    print_status "Installing icon..."
    mkdir -p /usr/share/m17n/icons/
    cp bn-khipro.png /usr/share/m17n/icons/
    print_success "Icon installed!"
else
    print_warning "Icon file not found, skipping icon installation."
fi

print_success "Keyboard files installed successfully!"

# Clean up
rm -rf /tmp/khipro-m17n

# Final instructions
echo ""
print_success "KhiproKeyboard installation completed!"
echo ""
print_status "Next steps:"
echo "1. Log out and log back in to restart your input method framework"
echo "2. Add KhiproKeyboard to your input method:"

if [ "$ibus_installed" = true ]; then
    echo "   - For IBus: Open IBus Preferences → Add input method: Bengali → Khipro"
fi

if [ "$fcitx_installed" = true ]; then
    echo "   - For Fcitx5: Open Fcitx5 Configuration → Add Khipro keyboard"
fi

# Show missing packages reminder if any
if [ ${#missing_packages[@]} -gt 0 ]; then
    echo ""
    print_warning "REMEMBER: You need to install these packages for KhiproKeyboard to work:"
    for pkg in "${missing_packages[@]}"; do
        echo "   - $pkg"
    done
fi

echo ""
print_status "If you encounter any issues, please visit:"
echo "https://t.me/KhiproKeyboard"
echo "Computer Log out kore Login korun"
